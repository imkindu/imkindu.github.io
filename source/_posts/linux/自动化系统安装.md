---
title: 运维自动化之系统安装
date: 2017-09-15 09:00:00
categories: linux
tags:
- 自动化
- 系统安装
---


　　刚学习Linux时，安装一个虚拟机操作系统，都是光盘启动，手动选项各个配置项，时区、主机名、网络等等，装个系统要等半小时。运维自动化就是将人从这些繁杂的事情中解放出来，利用`kickstart`实现自动化系统安装，现在就来看看是怎么实现的。

<!--more-->

---

## 光盘内容

　　首先让我们来看看，我们用光盘启动安装一个系统，那么光盘里面到底有什么呢？


　　光盘`isolinux`是核心目录，里面有我们装系统所使用的`内核`、`引导菜单`等

```shell
[ root@centos69 isolinux ]# ll
total 45306
-r--r--r--. 1 root root     2048 Aug  9 20:26 boot.cat          # 类似bootloader
-r--r--r--. 1 root root       84 Mar 29 02:19 boot.msg
-r--r--r--. 1 root root      321 Mar 29 02:19 grub.conf         
-r--r--r--. 1 root root 41587792 Mar 29 02:19 initrd.img        # 虚拟伪文件系统,是ramfs (先cpio，再gzip压缩)
-r--r--r--. 1 root root    24576 Mar 29 02:19 isolinux.bin      # stage2 第二阶段
-r--r--r--. 1 root root      923 Mar 29 02:19 isolinux.cfg      # 菜单
-r--r--r--. 1 root root   183012 Mar 29 02:19 memtest
-r--r--r--. 1 root root   151230 Mar 29 02:19 splash.jpg        # 菜单背景图片
-r--r--r--. 1 root root     2215 Aug  9 20:26 TRANS.TBL
-r--r--r--. 1 root root   163728 Mar 29 02:19 vesamenu.c32      # 启动菜单背景界面（cfg第一行）
-r-xr-xr-x. 1 root root  4274992 Mar 29 02:19 vmlinuz           # 内核，只有4M，还是很小的
```

### isolinux.cfg

　　首先，我们来看看配置文件`isolinux.cfg`

　　我们开启看到的光盘菜单界面就是这个配置文件配置的，这里面配置了`背景图片`、`菜单列表`、`菜单对应内核和参数`、`默认选择时间`、`标题`等，一一对应。涉及到的文件也都在`isolinux`这个文件夹中。

```shell
[ root@centos69 isolinux ]# cat isolinux.cfg 
default vesamenu.c32                            # 启动菜单背景风格
#prompt 1
timeout 600                                     # 倒计时，十分之一
display boot.msg
menu background splash.jpg                      # 背景图片
menu title Welcome to CentOS 6.9!               # 标题
menu color border 0 #ffffffff #00000000
menu color sel 7 #ffffffff #ff000000
menu color title 0 #ffffffff #00000000
menu color tabmsg 0 #ffffffff #00000000
menu color unsel 0 #ffffffff #00000000
menu color hotsel 0 #ff000000 #ffffffff
menu color hotkey 7 #ffffffff #ff000000
menu color scrollbar 0 #ffffffff #00000000
label linux                                             # 菜单选项 ^ 是可以快捷键字母选中菜单
  menu label ^Install or upgrade an existing system     
  menu default
  kernel vmlinuz                                        # 加载内核
  append initrd=initrd.img                              # 向内核传递参数
label vesa
  menu label Install system with ^basic video driver    # 基本图形显卡驱动
  kernel vmlinuz
  append initrd=initrd.img nomodeset
label rescue
  menu label ^Rescue installed system
  kernel vmlinuz
  append initrd=initrd.img rescue
label local
  menu label Boot from ^local drive
  localboot 0xffff
label memtest86
  menu label ^Memory test
  kernel memtest
  append -
```



<div align=center>
![](./001.png)
</div>

---

### 内核参数



　　再来看，不同菜单有什么区别呢？区别在于`append `后面对`内核传递不同参数`,多传递了一个`rescue`就代表救援模式。

　　但是咱们使用光盘启动，光盘是只读的，我们如何自定义使用哪些参数呢？其实，在我们进入到菜单界面后，根据启动界面提示`Press [Tab] to edit options`使用tab键，我们可以编辑内核参数。这里是编辑当前选中的菜单。

<div align=center>
![](./003.png)
</div>


　　另外还有一种办法编辑菜单，而这种方式是完全自定义，类似新增一个菜单。`esc` 可以切换不同菜单，填写label名，进入不同菜单,也可以在后面接其他参数。

>boot : linux rescue （菜单 参数）

<div align=center>
![](./esc.png)
</div>

### 文字安装


　　默认使用的图形界面`anaconda`，我们可以字符界面安装，向内核传递text参数

>boot : linux text


---

## 自动化安装

　　下面就是重头戏了，让我们来看一下，我们是如何一步步实现，自动化安装系统的。

### askmethod

　　利用`aksmethod`手动指定安装源

　　利用光盘安装时，安装用到的程序包默认是光盘里面自带的`Packages`,其实是可以不走光盘安装，而走网络安装的yum源，将程序包从光盘中提出来了。

>boot : linux askmethod 

　　之后就会让我们选择安装源的位置，可以`本地光盘`，`本地硬盘`，`NFS`，`URL`

<div align=center>
![](./askmethod.png)
</div>

<div align=center>
![](./url.png)
</div>


　　后续，就和原先光盘安装一样，实现了第一步，安装源的分离。


---


### kickstart


　　回顾，我们`anaconda`图形化安装过程，分为三个阶段


>安装前配置阶段
>>  安装过程使用的语言
  键盘类型
  安装目标存储设备
  Basic Storage：本地磁盘
  特殊设备：iSCSI
  设定主机名
  配置网络接口
  时区
  管理员密码
  设定分区方式及MBR的安装位置
  创建一个普通用户
  选定要安装的程序包


>安装阶段
>>在目标磁盘创建分区，执行格式化操作等
  将选定的程序包安装至目标位置
  安装bootloader和initramfs

>图形模式首次启动
>>iptables
  selinux
  core dump


　　重头戏来了，这么我们手动选择项，是否可以先写入一个配置文件，当安装系统时，自动帮我们选择呢？答案 就是我们的`kickstart`文件了，在我们用光盘安装完系统后，在root的家目录，就会生成这个`anaconda-ks.cfg`


---

## kickstart

　　现在就让我们来看看`kickstart`文件里面包含了哪些选项、又是怎么才能生成这个文件的。

---

### ks.cfg配置

　　我们先来看一个用光盘`anaconda`图形化安装后生成了的ks.cfg配置文件里面包含哪些选项

　　ks.cfg包含三大段：

>`命令段`：指明各种安装前配置，如键盘类型等

>`程序包段`：指明要安装的程序包组或程序包，不安装的程序包等
>>%packages
@group_name
package
-package
%end

>`脚本段`：
>>%pre: 安装前脚本
运行环境：运行于安装介质上的微型Linux环境
%post: 安装后脚本
运行环境：安装完成的系统


```shell
[ root@centos69 ~ ]# cat anaconda-ks.cfg 
#================================================脚命令段=========================================
# Kickstart file automatically generated by anaconda.
#version=DEVEL
install                                       # 安装
cdrom 
lang en_US.UTF-8                              # 语言
keyboard us                                   # 键盘
network --onboot no --device eth0 --bootproto dhcp --noipv6
rootpw  --iscrypted $6$OL4YFm8thjoyIQV3$OFs0x4jfVc9wH6O32l1SzrLAqoYG5mmDKCIQHPjfczjW/GUIw.H9QDOWsdJeg4xHRcE1qDfrrbY82azrsnNHm/
firewall --service=ssh
authconfig --enableshadow --passalgo=sha512
selinux --enforcing                           # selinux
timezone Asia/Shanghai                        # 时区
bootloader --location=mbr --driveorder=sda --append="crashkernel=auto rhgb quiet"
# The following is the partition information you requested
# Note that any partitions you deleted are not expressed
# here so unless you clear all partitions first, this is
# not guaranteed to work
# Clear the Master Boot Record
zerombr                                         # 清除引导
#clearpart --none                               # 清除分区表
#part /boot --fstype=ext4 --size=200            # 分区信息
#part / --fstype=ext4 --size=40960
#part /app --fstype=ext4 --size=5120
#part swap --size=2000
repo --name="CentOS"  --baseurl=cdrom:sr0 --cost=100
#================================================程序包段========================================
%packages
@base                                           # 包组名
@core                                           
@debugging
@development
@server-policy                                  # -package 表示排除，不安装（制定包组里面某个包不安装）
@workstation-policy                             # @ 开头表示包组
python-dmidecode                                # 一般的包
sgpio
device-mapper-persistent-data
systemtap-client
%end
#================================================脚本段=========================================
%post
echo -e 'Mage Education Learning Services\nhttp://www.magedu.com\n' >> /etc/issue
sed -i '1,$s@id:[0-9]:initdefault:@id:3:initdefault:@g' /etc/inittab
[ ! -d /root/.ssh ] && mkdir /root/.ssh && chmod og=--- /root/.ssh
# set hosts
echo '172.16.0.1  server.magelinux.com server' >> /etc/hosts
%end
```

　　这些内容不就是我们用图形化安装时，手动选择的选项嘛。

---

### system-config-kickstart

　　ks.cfg这么多配置选项，手动写，Oh my god，我可记不住，还是让我们请出`system-config-kickstart`工具来帮我们自动生成吧。但是，这个工具是`图形化`的，这就意味着，我们需要请出图形化系统来帮我们完成啦，最小化安装的字符界面可完成不了。

> yum install system-config-kickstart       # 安装system-config-kickstart

　　现在来看看他是怎么帮我们生产ks.cfg文件的

```shell
[root@centos69x fs] system-config-kickstart   # 调用system-config-kickstart命令
```

<div align=center>
![](./kick.png)
</div>

　　我擦，这不就是我们装系统时，所有的选择项嘛。在这里提前将所有的选项都配置完，保存就可以了。就会生成ks.cfg文件，里面包含所有的配置项。

---

### ksvalidator 

　　ks.cfg也许咱还不小心查看一下，或者是别人发给我的呢，我得先检查一下语法是否有问题啊，再看看配置项是否正确啊。来，请出`ksvalidator`帮我们检查语法格式。

　　咱先故意去掉最后的`%end` 的结束符号`%`，用ksvalidator帮我们检查一下，看嘛：`so easy`

> [root@centos69x fs]#  ksvalidatory ks.cfg

```shell
[root@centos69x fs]# ksvalidator 50-ks.cfg 
File uses a deprecated option or command.

%packages does not end with %end.  This syntax has been deprecated.  It may be removed from future releases, which will result in a fatal error from kickstart.  Please modify your kickstart file to use this updated syntax.
```

---

## ks.cfg安装系统

> boot : linux ks=ftp://172.18.56.10/pub/fs/50-ks.cfg

菜单编辑指明`kickstart`文件的位置：`ks=`

>DVD drive: ks=cdrom:/PATH/TO/KICKSTART_FILE
Hard drive: ks=hd:device:/directory/KICKSTART_FILE
HTTP server: ks=http://host:port/path/to/KICKSTART_FILE
FTP server: ks=ftp://host:port/path/to/KICKSTART_FILE
HTTPS server: ks=https://host:port/path/to/KICKSTART_FILE
NFS server:ks=nfs:host:/path/to/KICKSTART_FILE


　　剩下的事情就是：`我擦，我解放啦！`

<div align=center>
![](./kaixin.gif)
</div>


<div align=center>
![](./001.gif)
</div>

---

## U盘启动

　　前面咱们将程序包分离出来了，但是我们要启动安装程序，还是需要一个引导，咱们可以将这个引导做在U盘里，就不用随身携带一个光盘了。

　　制作U盘，总体思路比较简单，将光盘的isolinux里面的文件，利用`mkisofs`打包成一个可引导镜像即可。


```shell
[root@centos69x centos69]# tree
.
└── isolinux
    ├── bg.jpg
    ├── boot.cat
    ├── boot.msg
    ├── grub.conf
    ├── initrd.img
    ├── isolinux.bin
    ├── isolinux.cfg
    ├── isolinux.cfg.bak
    ├── memtest
    ├── splash.jpg
    ├── TRANS.TBL
    ├── vesamenu.c32
    └── vmlinuz
```

　　注意：以上命令的路径都是相对于光盘的根，而和工作目录无关（这句话还是不太懂，下面两个都可以，应该是-b指定的根目录）



>**mkisofs选项**
>>-o 指定映像文件的名称。
-b 指定在制作可开机光盘时所需的开机映像文件。
-c 制作可开机光盘时，会将开机映像文件中的no-eltorito-catalog 全部内容作成一个文件。
-no-emul-boot 非模拟模式启动。
-boot-load-size 4 设置载入部分的数量
-boot-info-table 在启动的图像中现实信息
-R 或-rock 使用Rock RidgeExtensions
-J 或-joliet 使用Joliet 格式的目录与文件名称
-v 或-verbose 执行时显示详细的信息
-T 或-translation-table 建立文件名的转换表，适用于不支持Rock Ridge Extensions 的系统上


```shell
# 进入了isolinux
mkisofs -R -J -T -v --no-emul-boot --boot-load-size 4 --boot-info-table -V "CentOS 6.9 imkindu boot" -b isolinux.bin -c boot.cat -o /root/CentOS6.9-imkindu.iso isolinux/
```

```shell
# 在外层目录 centos69
mkisofs -R -J -T -v --no-emul-boot --boot-load-size 4 --boot-info-table -V "CentOS 6.9 imkindu boot" -b isolinux/isolinux.bin -c boot.cat -o /root/CentOS6.9-imkindu.iso ../centos69/
```

　　利用ISO包，安装一个系统试试。

<div align=center>
![](./usb.png)
</div>



---

## 问题

> 1、centos7 system-config-kickstart配置安装程序时，如果使用的程序源是我们自己设定的，有个奇葩的问题，需要设置yum源名称为`development`,这样才能配置选项需要安装的程序包。

<div align=center>
![](./deve.png)
</div>