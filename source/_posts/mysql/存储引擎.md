---
title: 存储引擎
date: 2017-09-21 19:00:00
author: imkindu
categories: mysql
tags:
- mysql存储引擎
---

　　MySql也是客户/服务器系统并且是`单进程多线程`架构的数据库。MySql区别于其它数据库系统的一个重要特点是支持`插入式存储引擎`。

<!--more-->


## 什么是存储引擎

　　存储引擎说白了就是如何存储数据、如何为存储的数据建立索引和如何更新、查询数据等技术的实现方法。因为在关系数据库中数据的存储是以表的形式存储的，所以存储引擎也可以称为表类型（即存储和操作此表的类型）。

　　在Oracle 和SQL Server等数据库中只有一种存储引擎，所有数据存储管理机制都是一样的。而MySql数据库提供了多种存储引擎。用户可以根据不同的需求为数据表选择不同的存储引擎，用户也可以根据自己的需要编写自己的存储引擎。



## mariadb架构




---

## 存储引擎分类




> **查看所有引擎 : `show engines;`**


```
MariaDB [(none)]> show engines;
+--------------------+---------+----------------------------------------------------------------------------+--------------+------+------------+
| Engine             | Support | Comment                                                                    | Transactions | XA   | Savepoints |
+--------------------+---------+----------------------------------------------------------------------------+--------------+------+------------+
| MEMORY             | YES     | Hash based, stored in memory, useful for temporary tables                  | NO           | NO   | NO         |
| CSV                | YES     | CSV storage engine                                                         | NO           | NO   | NO         |
| PERFORMANCE_SCHEMA | YES     | Performance Schema                                                         | NO           | NO   | NO         |
| BLACKHOLE          | YES     | /dev/null storage engine (anything you write to it disappears)             | NO           | NO   | NO         |
| MyISAM             | YES     | MyISAM storage engine                                                      | NO           | NO   | NO         |
| MRG_MYISAM         | YES     | Collection of identical MyISAM tables                                      | NO           | NO   | NO         |
| ARCHIVE            | YES     | Archive storage engine                                                     | NO           | NO   | NO         |
| FEDERATED          | YES     | FederatedX pluggable storage engine                                        | YES          | NO   | YES        |
| InnoDB             | DEFAULT | Percona-XtraDB, Supports transactions, row-level locking, and foreign keys | YES          | YES  | YES        |
| Aria               | YES     | Crash-safe tables with MyISAM heritage                                     | NO           | NO   | NO         |
+--------------------+---------+----------------------------------------------------------------------------+--------------+------+------------+
```


## 引擎详解



### MyISAM



	支持全文索引（fulltext index）、压缩、空间函数（GIS），但是不支持事务，也不支持行级锁


锁粒度：表级锁


崩溃后无法安全恢复，后来改进为Aria 支持崩溃后安全恢复

修复需要手工或自动修复，但是可能丢失数据

索引：非聚集索引

延迟更新索引键：

压缩表：把表压缩后存放



使用场景：只读（或者写较少）、表较小（可接受长时间进行恢复操作）


每个表对应三个文件









　　不支持事务，也不支持外键、行级锁，访问速度快。

　　每个MyIsam在磁盘上存储为3个文件，其中文件名和表名都相同，拓展名分别为：

>- `.frm` 	存储表定义
- `.MYD` (MYData) 		存储数据
- `.MYI` (MYIndex) 	存储索引


```
-rw-rw----. 1 mysql mysql   8586 Sep 15 23:17 my_db.frm
-rw-rw----. 1 mysql mysql     20 Sep 15 23:18 my_db.MYD
-rw-rw----. 1 mysql mysql   2048 Sep 15 23:18 my_db.MYI
```

　　数据文件和索引文件可以放置在不同的目录，平均分配IO，获取更快的速度。要指定数据文件和索引文件的路径，需要在创建表的时候通过`DATA　DIRECTORY`和`INDEX　DIRECTORY`语句指定，文件路径需要使用绝对路径。


　　MyISAM：这种引擎是mysql最早提供的。这种引擎又可以分为静态MyISAM、动态MyISAM 和压缩MyISAM三种：


> `静态MyISAM`：如果数据表中的各数据列的长度都是预先固定好的，服务器将自动选择这种表类型。因为数据表中每一条记录所占用的空间都是一样的，所以这种表存取和更新的效率非常高。当数据受损时，恢复工作也比较容易做。
>
> `动态MyISAM`：如果数据表中出现varchar、xxxtext或xxxBLOB字段时，服务器将自动选择这种表类型。相对于静态MyISAM，这种表存储空间比较小，但由于每条记录的长度不一，所以多次修改数据后，数据表中的数据就可能离散的存储在内存中，进而导致执行效率下降。同时，内存中也可能会出现很多碎片。因此，这种类型的表要经常用optimize table 命令或优化工具来进行碎片整理。
>
>`压缩MyISAM`：以上说到的两种类型的表都可以用myisamchk工具压缩。这种类型的表进一步减小了占用的存储，但是这种表压缩之后不能再被修改。另外，因为是压缩数据，所以这种表在读取的时候要先时行解压缩。

---

### innodb

　　

处理大量的短期事务，数据存储于“表空间”(table space)中，

	1、所有InnoDB表的数据和索引放置于同一个表空间中
		.idb 	表空间文件 InnoDB Data,可能存在多个
			-rw-rw----. 1 mysql mysql  98304 Sep 15 20:33 user.ibd

		.frm 表格式定义文件

	2、每个表单独使用一个表空间存储表的数据和索引
		innodb_file_per_table 	配置

innodb_file_per_table=ON



数据存储：表空间
并发：基于MVCC，支持所有的四个隔离级别，默认界别为REPEATABLE READ，间隙锁防止 幻读
索引：聚集所有、辅助索引
性能：预计操作、自适应hash、插入缓存区来提升性能
备份：支持热备

锁粒度：行级锁



　　InnoDB存储引擎提供了具有提交、回滚和崩溃恢复能力的事务安全。但是对比MyISAM的存储引擎，InnoDB写的处理效率差一些并且会占用更多的磁盘空间以保留数据和索引。

`外键约束`

　　MySQL支持外键的存储引擎只有InnoDB，在创建外键的时候，父表必须有对应的索引，子表在创建外键的时候也会自动创建对应的索引。

　　在创建索引的时候，可以指定在删除、更新父表时，对子表进行的相应操作，包括restrict、cascade、set null和no action。其中restrict和no action相同，是指限制在子表有关联的情况下，父表不能更新；casecade表示父表在更新或删除时，更新或者删除子表对应的记录；set null 则表示父表在更新或者删除的时候，子表对应的字段被set null。

　　当某个表被其它表创建了外键参照，那么该表对应的索引或主键被禁止删除。

　　可以使用`set foreign_key_checks=0`;临时关闭外键约束，`set foreign_key_checks=1`;打开约束。

---

### memory


　　memory使用存在内存中的内容来创建表。每个MEMORY表实际对应一个磁盘文件，格式是.frm。MEMORY类型的表访问非常快，因为它到数据是放在内存中的，并且默认使用HASH索引，但是一旦服务器关闭，表中的数据就会丢失，但表还会继续存在。

　　默认情况下，memory数据表使用散列索引，利用这种索引进行“相等比较”非常快，但是对“范围比较”的速度就慢多了。因此，散列索引值适合使用在"="和"<=>"的操作符中，不适合使用在"<"或">"操作符中，也同样不适合用在order by字句里。如果确实要使用"<"或">"或betwen操作符，可以使用btree索引来加快速度。

　　存储在MEMORY数据表里的数据行使用的是长度不变的格式，因此加快处理速度，这意味着不能使用BLOB和TEXT这样的长度可变的数据类型。VARCHAR是一种长度可变的类型，但因为它在MySQL内部当作长度固定不变的CHAR类型，所以可以使用。


mysql的临时表都是memory,

### CSV

以普通csv格式文件，逗号分隔




### MRG_MYISAM

将多个myisam存储引擎合并为一个虚拟表


### BKACKHOLE 	黑洞 ，类似于/dev/null


### PERFORMANCE_SCHEMA

伪存储引擎，其内部数据只有在Mysql启动起来才存在，关闭后消失


### ARCHIVE 归档

只支持Insert 和 select操作，支持行级锁和专用缓存区，不支持事务



